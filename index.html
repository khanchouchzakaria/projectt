<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Product History</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 24px;
}
pre {
  background: #f5f5f5;
  padding: 16px;
  border-radius: 10px;
  white-space: pre-wrap;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>FreshChain – Product History</h2>
<pre id="out">Loading history...</pre>

<script>
const CONTRACT_ADDRESS = "0x7AeF3CEc79Ad1321e09b8F3263A7f817f459bD87";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
  {
    "inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],
    "name":"getBatchHistory",
    "outputs":[
      {
        "components":[
          {"internalType":"uint256","name":"batchId","type":"uint256"},
          {"internalType":"string","name":"productName","type":"string"},
          {"internalType":"uint256","name":"quantity","type":"uint256"},
          {"internalType":"address","name":"currentOwner","type":"address"},
          {"internalType":"bool","name":"arrived","type":"bool"},
          {"internalType":"bool","name":"inspectionPassed","type":"bool"},
          {
            "components":[
              {"internalType":"int256","name":"temperature","type":"int256"},
              {"internalType":"int256","name":"humidity","type":"int256"},
              {"internalType":"string","name":"location","type":"string"},
              {"internalType":"uint256","name":"timestamp","type":"uint256"},
              {"internalType":"address","name":"transporter","type":"address"}
            ],
            "internalType":"struct FreshChain.SensorData[]",
            "name":"sensors",
            "type":"tuple[]"
          },
          {
            "components":[
              {"internalType":"address","name":"from","type":"address"},
              {"internalType":"address","name":"to","type":"address"},
              {"internalType":"uint256","name":"timestamp","type":"uint256"}
            ],
            "internalType":"struct FreshChain.Ownership[]",
            "name":"ownerships",
            "type":"tuple[]"
          },
          {"internalType":"bool","name":"exists","type":"bool"}
        ],
        "internalType":"struct FreshChain.Batch",
        "name":"",
        "type":"tuple"
      }
    ],
    "stateMutability":"view",
    "type":"function"
  }
];

const out = document.getElementById("out");
const batchId = new URLSearchParams(window.location.search).get("batchId");

if (!batchId) {
  out.innerText = "❌ No batch ID provided in URL (?batchId=1)";
  throw new Error("Missing batchId");
}

(async () => {
  try {
    const provider = new ethers.providers.JsonRpcProvider(RPC);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    const b = await contract.getBatchHistory(batchId);

    if (!b.exists) {
      out.innerText = "❌ Batch does not exist.";
      return;
    }

    let text = `
Batch ID: ${b.batchId}
Product: ${b.productName}
Quantity: ${b.quantity}

Current Owner: ${b.currentOwner}
Arrived: ${b.arrived}
Inspection Passed: ${b.inspectionPassed}

--- SENSOR LOGS ---
`;

    if (b.sensors.length === 0) {
      text += "No sensor data recorded.\n";
    } else {
      b.sensors.forEach((s, i) => {
        text += `
#${i + 1}
Temperature: ${s.temperature} °C
Humidity: ${s.humidity} %
Location: ${s.location}
Time: ${new Date(s.timestamp * 1000).toLocaleString()}
Transporter: ${s.transporter}
`;
      });
    }

    text += "\n--- OWNERSHIP HISTORY ---\n";

    if (b.ownerships.length === 0) {
      text += "No ownership transfers recorded.\n";
    } else {
      b.ownerships.forEach((o, i) => {
        text += `
#${i + 1}
From: ${o.from}
To: ${o.to}
Time: ${new Date(o.timestamp * 1000).toLocaleString()}
`;
      });
    }

    out.innerText = text;

  } catch (e) {
    console.error(e);
    out.innerText =
      "❌ Error loading history.\n" +
      (e.reason || e.message || e);
  }
})();
</script>

</body>
</html>
