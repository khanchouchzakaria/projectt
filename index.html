<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Management Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 24px;
}
.card {
  border: 1px solid #ccc;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
}
input {
  padding: 8px;
  margin: 6px 0;
  width: 100%;
}
button {
  padding: 8px 14px;
  margin-top: 6px;
  cursor: pointer;
}
.status {
  margin-top: 6px;
  font-size: 14px;
}
.success {
  color: green;
}
.error {
  color: red;
}
small {
  color: #666;
}
</style>
</head>

<body>

<h2>FreshChain – Management Panel</h2>

<!-- CONNECT -->
<div class="card">
  <button onclick="connect()">Connect MetaMask</button>
  <p><b>Connected Account:</b> <span id="account">-</span></p>
</div>

<!-- ADMIN -->
<div class="card">
  <h3>Admin Panel (Owner Only)</h3>

  <input id="producerAddr" placeholder="Producer address">
  <button onclick="registerProducer()">Register Producer</button>
  <div id="producerStatus" class="status"></div>

  <input id="transporterAddr" placeholder="Transporter address">
  <button onclick="registerTransporter()">Register Transporter</button>
  <div id="transporterStatus" class="status"></div>

  <input id="distributorAddr" placeholder="Distributor address">
  <button onclick="registerDistributor()">Register Distributor</button>
  <div id="distributorStatus" class="status"></div>

  <input id="retailerAddr" placeholder="Retailer address">
  <button onclick="registerRetailer()">Register Retailer</button>
  <div id="retailerStatus" class="status"></div>

  <small>⚠️ MetaMask must be connected with the OWNER (deployer)</small>
</div>

<!-- PRODUCER -->
<div class="card">
  <h3>Producer – Create Batch</h3>
  <input id="bid" placeholder="Batch ID">
  <input id="pname" placeholder="Product name">
  <input id="qty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
  <div id="batchStatus" class="status"></div>
</div>

<!-- TRANSPORTER -->
<div class="card">
  <h3>Transporter – Add Sensor Data</h3>
  <input id="sid" placeholder="Batch ID">
  <input id="temp" placeholder="Temperature">
  <input id="hum" placeholder="Humidity">
  <input id="loc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor Data</button>
  <div id="sensorStatus" class="status"></div>
</div>

<!-- DISTRIBUTOR -->
<div class="card">
  <h3>Distributor – Transfer Ownership</h3>
  <input id="tid" placeholder="Batch ID">
  <input id="newOwner" placeholder="New owner address">
  <button onclick="transferOwner()">Transfer Ownership</button>
  <div id="transferStatus" class="status"></div>
</div>

<!-- RETAILER -->
<div class="card">
  <h3>Retailer – Mark As Arrived</h3>
  <input id="rid" placeholder="Batch ID">
  <button onclick="markArrived(true)">Passed</button>
  <button onclick="markArrived(false)">Failed</button>
  <div id="arrivalStatus" class="status"></div>
</div>

<!-- QR -->
<div class="card">
  <h3>Customer – Generate QR</h3>
  <input id="qrid" placeholder="Batch ID">
  <button onclick="generateQR()">Generate QR</button>
  <br><br>
  <img id="qrimg">
  <p id="qrlink"></p>
</div>

<script>
/* ================= CONFIG ================= */

const CONTRACT_ADDRESS = "0x4775403267e2665DEF8B4Db9d33250E785bF979C";

const ABI = [
  "function registerProducer(address)",
  "function registerTransporter(address)",
  "function registerDistributor(address)",
  "function registerRetailer(address)",
  "function createBatch(uint256,string,uint256)",
  "function addSensorData(uint256,int256,int256,string)",
  "function transferOwnership(uint256,address)",
  "function markAsArrived(uint256,bool)"
];

let provider, signer, contract;

/* ================= CONNECT ================= */

async function connect() {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  account.innerText = await signer.getAddress();
}

/* ================= STATUS HELPER ================= */

function setStatus(id, msg, type) {
  const el = document.getElementById(id);
  el.innerText = msg;
  el.className = "status " + type;
}

/* ================= ADMIN ================= */

async function registerProducer() {
  sendTx(
    () => contract.registerProducer(producerAddr.value),
    "producerStatus",
    "Producer registered"
  );
}

async function registerTransporter() {
  sendTx(
    () => contract.registerTransporter(transporterAddr.value),
    "transporterStatus",
    "Transporter registered"
  );
}

async function registerDistributor() {
  sendTx(
    () => contract.registerDistributor(distributorAddr.value),
    "distributorStatus",
    "Distributor registered"
  );
}

async function registerRetailer() {
  sendTx(
    () => contract.registerRetailer(retailerAddr.value),
    "retailerStatus",
    "Retailer registered"
  );
}

/* ================= ROLES ================= */

async function createBatch() {
  sendTx(
    () => contract.createBatch(bid.value, pname.value, qty.value),
    "batchStatus",
    "Batch created"
  );
}

async function addSensor() {
  sendTx(
    () => contract.addSensorData(sid.value, temp.value, hum.value, loc.value),
    "sensorStatus",
    "Sensor data added"
  );
}

async function transferOwner() {
  sendTx(
    () => contract.transferOwnership(tid.value, newOwner.value),
    "transferStatus",
    "Ownership transferred"
  );
}

async function markArrived(passed) {
  sendTx(
    () => contract.markAsArrived(rid.value, passed),
    "arrivalStatus",
    passed ? "Inspection passed" : "Inspection failed"
  );
}

/* ================= TX HANDLER ================= */

async function sendTx(fn, statusId, successMsg) {
  try {
    const tx = await fn();
    await tx.wait();
    setStatus(statusId, "✅ " + successMsg, "success");
  } catch (e) {
    setStatus(
      statusId,
      "❌ " + (e.reason || "Transaction failed"),
      "error"
    );
  }
}

/* ================= QR ================= */

function generateQR() {
  const url =
    location.origin +
    location.pathname.replace("index.html", "") +
    "scan.html?batchId=" + qrid.value;

  qrimg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);

  qrlink.innerText = url;
}
</script>

</body>
</html>
