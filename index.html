<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FreshChain DApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
    h1 { margin-bottom: 5px; }
    .card { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, select, button {
      width:100%; padding:8px; margin-top:5px;
    }
    button { cursor:pointer; font-weight:bold; }
    .ok { background:#e7ffe7; padding:10px; margin-top:10px; }
    .err { background:#ffe7e7; padding:10px; margin-top:10px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; font-size:14px; }
    th { background:#eee; }
    code { background:#eee; padding:2px 6px; border-radius:4px; }
  </style>
</head>

<body>

<h1>FreshChain</h1>
<p>Blockchain Food Traceability (Sepolia)</p>

<div class="card">
  <button id="btnConnect">Connect MetaMask</button>
  <p>Wallet: <code id="walletAddr">Not connected</code></p>
  <p>Network: <code id="network">-</code></p>

  <label>Select Role</label>
  <select id="roleSelect" disabled>
    <option value="customer">Customer</option>
    <option value="admin">Admin</option>
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="retailer">Retailer</option>
  </select>

  <div id="globalStatus"></div>
</div>

<!-- ADMIN -->
<div class="card" id="adminPanel" style="display:none;">
  <h3>Admin</h3>
  <label>Address</label>
  <input id="adminAddr" placeholder="0x..." />
  <button id="btnRegProducer">Register Producer</button>
  <button id="btnRegTransporter">Register Transporter</button>
  <button id="btnRegRetailer">Register Retailer</button>
  <div id="adminStatus"></div>
</div>

<!-- PRODUCER -->
<div class="card" id="producerPanel" style="display:none;">
  <h3>Producer</h3>
  <label>Batch ID</label>
  <input id="pBatchId" />
  <label>Product</label>
  <input id="pName" />
  <label>Quantity</label>
  <input id="pQty" />
  <button id="btnCreateBatch">Create Batch</button>
  <div id="producerStatus"></div>
</div>

<!-- TRANSPORTER -->
<div class="card" id="transporterPanel" style="display:none;">
  <h3>Transporter</h3>
  <label>Batch ID</label>
  <input id="tBatchId" />
  <label>Temperature</label>
  <input id="tTemp" />
  <label>Humidity</label>
  <input id="tHum" />
  <label>Location</label>
  <input id="tLoc" />
  <button id="btnAddSensor">Add Sensor</button>
  <div id="transporterStatus"></div>
</div>

<!-- RETAILER -->
<div class="card" id="retailerPanel" style="display:none;">
  <h3>Retailer</h3>
  <label>Batch ID</label>
  <input id="rBatchId" />
  <label>Passed Inspection?</label>
  <select id="rPassed">
    <option value="true">Yes</option>
    <option value="false">No</option>
  </select>
  <button id="btnArrived">Mark Arrived</button>
  <div id="retailerStatus"></div>
</div>

<!-- TRANSFER -->
<div class="card">
  <h3>Transfer Ownership</h3>
  <label>Batch ID</label>
  <input id="xBatchId" />
  <label>New Owner</label>
  <input id="xOwner" />
  <button id="btnTransfer">Transfer</button>
  <div id="transferStatus"></div>
</div>

<!-- CUSTOMER -->
<div class="card">
  <h3>Customer View</h3>
  <label>Batch ID</label>
  <input id="cBatchId" />
  <button id="btnHistory">Load History</button>
  <div id="history"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const CONTRACT_ADDRESS = "0x6b9b534daD5Fa5cFDba20E30D6a1ae7040b8c6b9";

  const ABI = /* YOUR ABI */ ${JSON.stringify([
    {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"}],"name":"addSensorData","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"createBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"bool","name":"passed","type":"bool"}],"name":"markAsArrived","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],"name":"getBatchHistory","outputs":[{"internalType":"tuple","name":"","components":[
      {"internalType":"uint256","name":"batchId","type":"uint256"},
      {"internalType":"string","name":"productName","type":"string"},
      {"internalType":"uint256","name":"quantity","type":"uint256"},
      {"internalType":"address","name":"currentOwner","type":"address"},
      {"internalType":"bool","name":"arrived","type":"bool"},
      {"internalType":"bool","name":"inspectionPassed","type":"bool"},
      {"internalType":"tuple[]","name":"sensors","components":[
        {"internalType":"int256","name":"temperature","type":"int256"},
        {"internalType":"int256","name":"humidity","type":"int256"},
        {"internalType":"string","name":"location","type":"string"},
        {"internalType":"uint256","name":"timestamp","type":"uint256"},
        {"internalType":"address","name":"transporter","type":"address"}
      ]},
      {"internalType":"tuple[]","name":"ownerships","components":[
        {"internalType":"address","name":"from","type":"address"},
        {"internalType":"address","name":"to","type":"address"},
        {"internalType":"uint256","name":"timestamp","type":"uint256"}
      ]},
      {"internalType":"bool","name":"exists","type":"bool"}
    ]}],"stateMutability":"view","type":"function"}
  ], null, 2)};

  const el = id => document.getElementById(id);
  let provider, signer, contract;

  el("btnConnect").onclick = async () => {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    el("walletAddr").textContent = await signer.getAddress();
    el("network").textContent = (await provider.getNetwork()).name;
    el("roleSelect").disabled = false;
  };

  el("roleSelect").onchange = e => {
    ["admin","producer","transporter","retailer"].forEach(r => el(r+"Panel").style.display="none");
    if (el(e.target.value+"Panel")) el(e.target.value+"Panel").style.display="block";
  };

  el("btnRegProducer").onclick = async () =>
    el("adminStatus").innerHTML = (await contract.registerProducer(el("adminAddr").value)).hash;

  el("btnRegTransporter").onclick = async () =>
    el("adminStatus").innerHTML = (await contract.registerTransporter(el("adminAddr").value)).hash;

  el("btnRegRetailer").onclick = async () =>
    el("adminStatus").innerHTML = (await contract.registerRetailer(el("adminAddr").value)).hash;

  el("btnCreateBatch").onclick = async () =>
    el("producerStatus").innerHTML = (await contract.createBatch(el("pBatchId").value, el("pName").value, el("pQty").value)).hash;

  el("btnAddSensor").onclick = async () =>
    el("transporterStatus").innerHTML = (await contract.addSensorData(el("tBatchId").value, el("tTemp").value, el("tHum").value, el("tLoc").value)).hash;

  el("btnArrived").onclick = async () =>
    el("retailerStatus").innerHTML = (await contract.markAsArrived(el("rBatchId").value, el("rPassed").value==="true")).hash;

  el("btnTransfer").onclick = async () =>
    el("transferStatus").innerHTML = (await contract.transferOwnership(el("xBatchId").value, el("xOwner").value)).hash;

  el("btnHistory").onclick = async () => {
    const b = await contract.getBatchHistory(el("cBatchId").value);
    el("history").innerHTML = "<pre>"+JSON.stringify(b,null,2)+"</pre>";
  };

});
</script>

</body>
</html>

