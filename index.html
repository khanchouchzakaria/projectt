<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Management Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 24px;
}
.card {
  border: 1px solid #ccc;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
}
input {
  padding: 8px;
  margin: 6px 0;
  width: 100%;
}
button {
  padding: 8px 14px;
  margin-top: 6px;
  cursor: pointer;
}
small {
  color: #666;
}
</style>
</head>

<body>

<h2>FreshChain – Management Panel</h2>

<!-- CONNECT -->
<div class="card">
  <button onclick="connect()">Connect MetaMask</button>
  <p><b>Connected Account:</b> <span id="account">-</span></p>
</div>

<!-- ADMIN PANEL -->
<div class="card">
  <h3>Admin Panel (Owner Only)</h3>

  <input id="producerAddr" placeholder="Producer address (0x...)">
  <button onclick="registerProducer()">Register Producer</button>

  <input id="transporterAddr" placeholder="Transporter address (0x...)">
  <button onclick="registerTransporter()">Register Transporter</button>

  <input id="distributorAddr" placeholder="Distributor address (0x...)">
  <button onclick="registerDistributor()">Register Distributor</button>

  <input id="retailerAddr" placeholder="Retailer address (0x...)">
  <button onclick="registerRetailer()">Register Retailer</button>

  <small>
    ⚠️ MetaMask must be connected with the <b>OWNER (deployer)</b> wallet
  </small>
</div>

<!-- PRODUCER -->
<div class="card">
  <h3>Producer – Create Batch</h3>
  <input id="bid" placeholder="Batch ID">
  <input id="pname" placeholder="Product name">
  <input id="qty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
</div>

<!-- TRANSPORTER -->
<div class="card">
  <h3>Transporter – Add Sensor Data</h3>
  <input id="sid" placeholder="Batch ID">
  <input id="temp" placeholder="Temperature">
  <input id="hum" placeholder="Humidity">
  <input id="loc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor Data</button>
</div>

<!-- DISTRIBUTOR -->
<div class="card">
  <h3>Distributor – Transfer Ownership</h3>
  <input id="tid" placeholder="Batch ID">
  <input id="newOwner" placeholder="New owner address">
  <button onclick="transferOwner()">Transfer Ownership</button>
</div>

<!-- RETAILER -->
<div class="card">
  <h3>Retailer – Mark As Arrived</h3>
  <input id="rid" placeholder="Batch ID">
  <button onclick="markArrived(true)">Passed</button>
  <button onclick="markArrived(false)">Failed</button>
</div>

<!-- QR -->
<div class="card">
  <h3>Customer – Generate QR</h3>
  <input id="qrid" placeholder="Batch ID">
  <button onclick="generateQR()">Generate QR</button>
  <br><br>
  <img id="qrimg">
  <p id="qrlink"></p>
</div>

<script>
/* ================= CONFIG ================= */

const CONTRACT_ADDRESS = "0x4775403267e2665DEF8B4Db9d33250E785bF979C";

const ABI = [
  "function registerProducer(address)",
  "function registerTransporter(address)",
  "function registerDistributor(address)",
  "function registerRetailer(address)",
  "function createBatch(uint256,string,uint256)",
  "function addSensorData(uint256,int256,int256,string)",
  "function transferOwnership(uint256,address)",
  "function markAsArrived(uint256,bool)"
];

let provider, signer, contract;

/* ================= CONNECT ================= */

async function connect() {
  if (!window.ethereum) {
    alert("MetaMask not detected");
    return;
  }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  account.innerText = await signer.getAddress();
}

/* ================= ADMIN ================= */

async function registerProducer() {
  await sendTx(() => contract.registerProducer(producerAddr.value));
}

async function registerTransporter() {
  await sendTx(() => contract.registerTransporter(transporterAddr.value));
}

async function registerDistributor() {
  await sendTx(() => contract.registerDistributor(distributorAddr.value));
}

async function registerRetailer() {
  await sendTx(() => contract.registerRetailer(retailerAddr.value));
}

/* ================= ROLES ================= */

async function createBatch() {
  await sendTx(() => contract.createBatch(bid.value, pname.value, qty.value));
}

async function addSensor() {
  await sendTx(() =>
    contract.addSensorData(sid.value, temp.value, hum.value, loc.value)
  );
}

async function transferOwner() {
  await sendTx(() =>
    contract.transferOwnership(tid.value, newOwner.value)
  );
}

async function markArrived(passed) {
  await sendTx(() =>
    contract.markAsArrived(rid.value, passed)
  );
}

/* ================= HELPERS ================= */

async function sendTx(fn) {
  try {
    const tx = await fn();
    await tx.wait();
    alert("✅ Transaction successful");
  } catch (e) {
    alert(
      e?.reason ||
      e?.error?.message ||
      "❌ Transaction failed (check role / owner)"
    );
  }
}

/* ================= QR ================= */

function generateQR() {
  const url =
    location.origin +
    location.pathname.replace("index.html", "") +
    "scan.html?batchId=" + qrid.value;

  qrimg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);

  qrlink.innerText = url;
}
</script>

</body>
</html>
