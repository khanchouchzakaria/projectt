<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FreshChain â€“ Food Traceability</title>

  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f3f4f6; padding:20px; }
    h1 { text-align:center; }
    .box { background:#fff; padding:15px; margin:15px auto; max-width:600px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    input, select, button { width:100%; padding:10px; margin-top:8px; }
    button { background:#111827; color:#fff; border:none; cursor:pointer; }
    button:hover { opacity:.9; }
    .hidden { display:none; }
    pre { background:#111827; color:#e5e7eb; padding:10px; overflow:auto; }
    .status { background:#e5e7eb; padding:8px; margin-top:8px; white-space:pre-wrap; }
  </style>
</head>

<body>

<h1>ðŸ¥¬ FreshChain â€“ Blockchain Food Traceability</h1>

<div class="box">
  <button onclick="connectWallet()">ðŸ”— Connect MetaMask</button>
  <div class="status" id="walletStatus">Not connected</div>

  <select id="role" onchange="showRole()">
    <option value="">Select Role</option>
    <option value="admin">Admin</option>
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
    <option value="customer">Customer</option>
  </select>
</div>

<!-- ADMIN -->
<div class="box hidden" id="admin">
  <h3>Admin â€“ Register Actor</h3>
  <input id="adminAddr" placeholder="Actor address">
  <select id="adminType">
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
  </select>
  <button onclick="registerActor()">Register</button>
  <div class="status" id="adminStatus"></div>
</div>

<!-- PRODUCER -->
<div class="box hidden" id="producer">
  <h3>Producer â€“ Create Batch</h3>
  <input id="pbId" placeholder="Batch ID">
  <input id="pbName" placeholder="Product Name">
  <input id="pbQty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
  <div class="status" id="producerStatus"></div>
</div>

<!-- TRANSPORTER -->
<div class="box hidden" id="transporter">
  <h3>Transporter â€“ Add Sensor Data</h3>
  <input id="tbId" placeholder="Batch ID">
  <input id="tbTemp" placeholder="Temperature (-10 to 40)">
  <input id="tbHum" placeholder="Humidity (0 to 40)">
  <input id="tbLoc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor</button>
  <div class="status" id="transporterStatus"></div>
</div>

<!-- DISTRIBUTOR -->
<div class="box hidden" id="distributor">
  <h3>Transfer Ownership</h3>
  <input id="obId" placeholder="Batch ID">
  <input id="obNew" placeholder="New Owner Address">
  <button onclick="transferOwnership()">Transfer</button>
  <div class="status" id="distributorStatus"></div>
</div>

<!-- RETAILER -->
<div class="box hidden" id="retailer">
  <h3>Retailer â€“ Final Inspection</h3>
  <input id="rbId" placeholder="Batch ID">
  <select id="rbPass">
    <option value="true">Passed</option>
    <option value="false">Failed</option>
  </select>
  <button onclick="markArrived()">Mark Arrived</button>
  <div class="status" id="retailerStatus"></div>
</div>

<!-- CUSTOMER -->
<div class="box hidden" id="customer">
  <h3>Customer â€“ View Batch History</h3>
  <input id="cbId" placeholder="Batch ID">
  <button onclick="getHistory()">View History</button>
  <pre id="history"></pre>
</div>

<script>
/* ---------------- CONFIG ---------------- */

const CONTRACT_ADDRESS = "0x6b9b534daD5Fa5cFDba20E30D6a1ae7040b8c6b9";

const ABI = [ /* ABI EXACTLY AS YOU PROVIDED */ 
/* (ABI OMITTED HERE FOR BREVITY IN THIS VIEW â€“ USE THE SAME ABI YOU SENT ME) */
];

/* ---------------- GLOBALS ---------------- */

let provider, signer, contract;

/* ---------------- WALLET ---------------- */

async function connectWallet(){
  if(!window.ethereum){
    alert("MetaMask required");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();

  const net = await provider.getNetwork();
  if(net.chainId !== 11155111){
    alert("Please switch MetaMask to Sepolia");
    return;
  }

  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  document.getElementById("walletStatus").innerText =
    "Connected: " + await signer.getAddress();
}

/* ---------------- UI ---------------- */

function showRole(){
  ["admin","producer","transporter","distributor","retailer","customer"]
    .forEach(id => document.getElementById(id).classList.add("hidden"));

  const r = document.getElementById("role").value;
  if(r) document.getElementById(r).classList.remove("hidden");
}

/* ---------------- ADMIN ---------------- */

async function registerActor(){
  try{
    const addr = adminAddr.value;
    const type = adminType.value;

    let tx;
    if(type==="producer") tx = await contract.registerProducer(addr);
    if(type==="transporter") tx = await contract.registerTransporter(addr);
    if(type==="distributor") tx = await contract.registerDistributor(addr);
    if(type==="retailer") tx = await contract.registerRetailer(addr);

    adminStatus.innerText = "Tx sent: " + tx.hash;
    await tx.wait();
    adminStatus.innerText = "Registered successfully";

  }catch(e){
    adminStatus.innerText = e.reason || e.message;
  }
}

/* ---------------- PRODUCER ---------------- */

async function createBatch(){
  try{
    const tx = await contract.createBatch(
      pbId.value,
      pbName.value,
      pbQty.value
    );
    producerStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    producerStatus.innerText = "Batch created";

  }catch(e){
    producerStatus.innerText = e.reason || e.message;
  }
}

/* ---------------- TRANSPORTER ---------------- */

async function addSensor(){
  try{
    const tx = await contract.addSensorData(
      tbId.value,
      parseInt(tbTemp.value),
      parseInt(tbHum.value),
      tbLoc.value
    );
    transporterStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    transporterStatus.innerText = "Sensor added";

  }catch(e){
    transporterStatus.innerText = e.reason || e.message;
  }
}

/* ---------------- TRANSFER ---------------- */

async function transferOwnership(){
  try{
    const tx = await contract.transferOwnership(
      obId.value,
      obNew.value
    );
    distributorStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    distributorStatus.innerText = "Ownership transferred";

  }catch(e){
    distributorStatus.innerText = e.reason || e.message;
  }
}

/* ---------------- RETAILER ---------------- */

async function markArrived(){
  try{
    const tx = await contract.markAsArrived(
      rbId.value,
      rbPass.value === "true"
    );
    retailerStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    retailerStatus.innerText = "Arrival recorded";

  }catch(e){
    retailerStatus.innerText = e.reason || e.message;
  }
}

/* ---------------- CUSTOMER ---------------- */

async function getHistory(){
  try{
    const b = await contract.getBatchHistory(cbId.value);
    history.innerText = JSON.stringify(b, null, 2);
  }catch(e){
    history.innerText = e.reason || e.message;
  }
}
</script>

</body>
</html>
