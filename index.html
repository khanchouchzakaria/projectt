<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain â€“ Food Traceability</title>

<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f3f4f6; padding:20px; }
h1 { text-align:center; }
.card {
  background:#fff;
  max-width:600px;
  margin:15px auto;
  padding:15px;
  border-radius:8px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
input, select, button {
  width:100%;
  padding:10px;
  margin-top:8px;
}
button {
  background:#111827;
  color:#fff;
  border:none;
  cursor:pointer;
}
.hidden { display:none; }
.status {
  background:#e5e7eb;
  padding:8px;
  margin-top:8px;
  white-space:pre-wrap;
}
pre {
  background:#111827;
  color:#e5e7eb;
  padding:10px;
  overflow:auto;
}
</style>
</head>

<body>

<h1>ðŸ¥¬ FreshChain â€“ Blockchain Food Traceability</h1>

<div class="card">
  <button onclick="connectWallet()">ðŸ”— Connect MetaMask</button>
  <div class="status" id="walletStatus">Not connected</div>

  <select id="role" onchange="showRole()">
    <option value="">Select Role</option>
    <option value="admin">Admin</option>
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
    <option value="customer">Customer</option>
  </select>
</div>

<div class="card hidden" id="admin">
  <h3>Admin â€“ Register Actor</h3>
  <input id="adminAddr" placeholder="Actor address">
  <select id="adminType">
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
  </select>
  <button onclick="registerActor()">Register</button>
  <div class="status" id="adminStatus"></div>
</div>

<div class="card hidden" id="producer">
  <h3>Producer â€“ Create Batch</h3>
  <input id="pbId" placeholder="Batch ID">
  <input id="pbName" placeholder="Product Name">
  <input id="pbQty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
  <div class="status" id="producerStatus"></div>
</div>

<div class="card hidden" id="transporter">
  <h3>Transporter â€“ Add Sensor Data</h3>
  <input id="tbId" placeholder="Batch ID">
  <input id="tbTemp" placeholder="Temperature (-10 to 40)">
  <input id="tbHum" placeholder="Humidity (0 to 40)">
  <input id="tbLoc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor</button>
  <div class="status" id="transporterStatus"></div>
</div>

<div class="card hidden" id="distributor">
  <h3>Transfer Ownership</h3>
  <input id="obId" placeholder="Batch ID">
  <input id="obNew" placeholder="New Owner Address">
  <button onclick="transferOwnership()">Transfer</button>
  <div class="status" id="distributorStatus"></div>
</div>

<div class="card hidden" id="retailer">
  <h3>Retailer â€“ Final Inspection</h3>
  <input id="rbId" placeholder="Batch ID">
  <select id="rbPass">
    <option value="true">Passed</option>
    <option value="false">Failed</option>
  </select>
  <button onclick="markArrived()">Mark Arrived</button>
  <div class="status" id="retailerStatus"></div>
</div>

<div class="card hidden" id="customer">
  <h3>Customer â€“ View Batch History</h3>
  <input id="cbId" placeholder="Batch ID">
  <button onclick="getHistory()">View History</button>
  <pre id="history"></pre>
</div>

<script>
/* ================= CONFIG ================= */

const CONTRACT_ADDRESS = "0x6b9b534daD5Fa5cFDba20E30D6a1ae7040b8c6b9";

const ABI = [/* FULL ABI EXACTLY AS YOU PROVIDED â€” PASTE IT HERE AGAIN */];

/* ================= GLOBALS ================= */

let provider;
let signer;
let contract;

/* ================= CONNECT ================= */

async function connectWallet() {
  try {
    if (typeof window.ethereum === "undefined") {
      alert("MetaMask is not installed");
      return;
    }

    const accounts = await window.ethereum.request({
      method: "eth_requestAccounts"
    });

    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();

    const network = await provider.getNetwork();
    if (network.chainId !== 11155111) {
      alert("Please switch MetaMask to Sepolia");
      return;
    }

    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    document.getElementById("walletStatus").innerText =
      "Connected âœ…\n" + accounts[0] + "\nNetwork: Sepolia";

  } catch (err) {
    console.error(err);
    alert("Connection failed: " + err.message);
  }
}

/* ================= UI ================= */

function showRole() {
  ["admin","producer","transporter","distributor","retailer","customer"]
    .forEach(r => document.getElementById(r).classList.add("hidden"));

  const role = document.getElementById("role").value;
  if (role) document.getElementById(role).classList.remove("hidden");
}

/* ================= ADMIN ================= */

async function registerActor() {
  try {
    let tx;
    const addr = adminAddr.value;
    const type = adminType.value;

    if (type === "producer") tx = await contract.registerProducer(addr);
    if (type === "transporter") tx = await contract.registerTransporter(addr);
    if (type === "distributor") tx = await contract.registerDistributor(addr);
    if (type === "retailer") tx = await contract.registerRetailer(addr);

    adminStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    adminStatus.innerText = "Registered successfully";

  } catch (e) {
    adminStatus.innerText = e.reason || e.message;
  }
}

/* ================= PRODUCER ================= */

async function createBatch() {
  try {
    const tx = await contract.createBatch(pbId.value, pbName.value, pbQty.value);
    producerStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    producerStatus.innerText = "Batch created";
  } catch (e) {
    producerStatus.innerText = e.reason || e.message;
  }
}

/* ================= TRANSPORTER ================= */

async function addSensor() {
  try {
    const tx = await contract.addSensorData(
      tbId.value,
      parseInt(tbTemp.value),
      parseInt(tbHum.value),
      tbLoc.value
    );
    transporterStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    transporterStatus.innerText = "Sensor added";
  } catch (e) {
    transporterStatus.innerText = e.reason || e.message;
  }
}

/* ================= TRANSFER ================= */

async function transferOwnership() {
  try {
    const tx = await contract.transferOwnership(obId.value, obNew.value);
    distributorStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    distributorStatus.innerText = "Ownership transferred";
  } catch (e) {
    distributorStatus.innerText = e.reason || e.message;
  }
}

/* ================= RETAILER ================= */

async function markArrived() {
  try {
    const tx = await contract.markAsArrived(rbId.value, rbPass.value === "true");
    retailerStatus.innerText = "Tx: " + tx.hash;
    await tx.wait();
    retailerStatus.innerText = "Arrival recorded";
  } catch (e) {
    retailerStatus.innerText = e.reason || e.message;
  }
}

/* ================= CUSTOMER ================= */

async function getHistory() {
  try {
    const data = await contract.getBatchHistory(cbId.value);
    history.innerText = JSON.stringify(data, null, 2);
  } catch (e) {
    history.innerText = e.reason || e.message;
  }
}
</script>

</body>
</html>
