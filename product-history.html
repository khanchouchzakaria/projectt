<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Product History</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Ethers v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 24px;
}
pre {
  background: #f5f5f5;
  padding: 16px;
  border-radius: 10px;
  white-space: pre-wrap;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>FreshChain – Product History</h2>
<pre id="out">Loading history...</pre>

<script>
const CONTRACT_ADDRESS = "0x6ceBE33E9d81a4673c098c69B748D8a10e8BaeCa";
const RPC = "https://eth-sepolia.g.alchemy.com/v2/7nq9DSo1P4TvLc7p9bOfr";

const ABI = [
  "function getBatchHistory(uint256) view returns (" +
  "uint256,string,uint256," +
  "address,address,address,address," +
  "bool,bool," +
  "(int256,int256,string,uint256,address)[]," +
  "(address,address,uint256)[]" +
  ")"
];

const out = document.getElementById("out");
const batchId = new URLSearchParams(window.location.search).get("batchId");

if (!batchId) {
  out.innerText = "❌ No batch ID provided in URL (?batchId=1)";
  throw new Error("Missing batchId");
}

(async () => {
  try {
    const provider = new ethers.providers.JsonRpcProvider(RPC);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    const b = await contract.getBatchHistory(batchId);

    let text = `
Batch ID: ${b[0]}
Product: ${b[1]}
Quantity: ${b[2]}

Producer: ${b[3]}
Current Owner: ${b[4]}
Distributor: ${b[5]}
Retailer: ${b[6]}

Arrived: ${b[7]}
Inspection Passed: ${b[8]}

--- SENSOR LOGS ---
`;

    if (b[9].length === 0) {
      text += "No sensor data recorded.\n";
    } else {
      b[9].forEach((s, i) => {
        text += `
#${i + 1}
Temperature: ${s[0]} °C
Humidity: ${s[1]} %
Location: ${s[2]}
Time: ${new Date(s[3] * 1000).toLocaleString()}
Transporter: ${s[4]}
`;
      });
    }

    text += "\n--- OWNERSHIP HISTORY ---\n";

    if (b[10].length === 0) {
      text += "No ownership transfers recorded.\n";
    } else {
      b[10].forEach((o, i) => {
        text += `
#${i + 1}
From: ${o[0]}
To: ${o[1]}
Time: ${new Date(o[2] * 1000).toLocaleString()}
`;
      });
    }

    out.innerText = text;

  } catch (e) {
    console.error(e);
    out.innerText =
      "❌ Error loading history.\n" +
      (e.reason || e.message || e);
  }
})();
</script>

</body>
</html>

