<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FreshChain – Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body { font-family: Arial; margin: 24px; }
.card { border:1px solid #ccc; padding:16px; border-radius:10px; margin-bottom:16px; }
input, button { padding:8px; margin:4px; }
button { cursor:pointer; }
pre { background:#f5f5f5; padding:10px; }
</style>
</head>

<body>

<h2>FreshChain – Management Panel</h2>

<div class="card">
  <button onclick="connect()">Connect MetaMask</button>
  <p><b>Account:</b> <span id="account">-</span></p>
</div>

<div class="card">
  <h3>Admin – Register Roles</h3>
  <input id="roleAddr" placeholder="0x address">
  <br>
  <button onclick="register('registerProducer')">Producer</button>
  <button onclick="register('registerTransporter')">Transporter</button>
  <button onclick="register('registerDistributor')">Distributor</button>
  <button onclick="register('registerRetailer')">Retailer</button>
</div>

<div class="card">
  <h3>Producer – Create Batch</h3>
  <input id="bid" placeholder="Batch ID">
  <input id="pname" placeholder="Product name">
  <input id="qty" placeholder="Quantity">
  <button onclick="createBatch()">Create Batch</button>
</div>

<div class="card">
  <h3>Transporter – Add Sensor Data</h3>
  <input id="sid" placeholder="Batch ID">
  <input id="temp" placeholder="Temperature">
  <input id="hum" placeholder="Humidity">
  <input id="loc" placeholder="Location">
  <button onclick="addSensor()">Add Sensor</button>
</div>

<div class="card">
  <h3>Distributor – Transfer Ownership</h3>
  <input id="tid" placeholder="Batch ID">
  <input id="newOwner" placeholder="New owner address">
  <button onclick="transferOwner()">Transfer</button>
</div>

<div class="card">
  <h3>Retailer – Mark As Arrived</h3>
  <input id="rid" placeholder="Batch ID">
  <button onclick="markArrived(true)">Passed</button>
  <button onclick="markArrived(false)">Failed</button>
</div>

<div class="card">
  <h3>Customer – Generate QR</h3>
  <input id="qrid" placeholder="Batch ID">
  <button onclick="generateQR()">Generate QR</button>
  <br><br>
  <img id="qrimg">
  <p id="qrlink"></p>
</div>

<script>
const CONTRACT_ADDRESS = "0x9167AD9a32c5148F461bc6EbE9831236337f2612";

const ABI = [
 "function registerProducer(address)",
 "function registerTransporter(address)",
 "function registerDistributor(address)",
 "function registerRetailer(address)",
 "function createBatch(uint256,string,uint256)",
 "function addSensorData(uint256,int256,int256,string)",
 "function transferOwnership(uint256,address)",
 "function markAsArrived(uint256,bool)"
];

let signer, contract;

async function connect(){
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  account.innerText = await signer.getAddress();
}

async function register(fn){
  await contract[fn](roleAddr.value);
  alert("Role registered");
}

async function createBatch(){
  await contract.createBatch(bid.value, pname.value, qty.value);
  alert("Batch created");
}

async function addSensor(){
  await contract.addSensorData(sid.value, temp.value, hum.value, loc.value);
  alert("Sensor data added");
}

async function transferOwner(){
  await contract.transferOwnership(tid.value, newOwner.value);
  alert("Ownership transferred");
}

async function markArrived(passed){
  await contract.markAsArrived(rid.value, passed);
  alert("Marked arrived");
}

function generateQR(){
  const url =
    location.origin +
    location.pathname.replace("index.html","") +
    "scan.html?batchId=" + qrid.value;

  qrimg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(url);

  qrlink.innerText = url;
}
</script>

</body>
</html>
